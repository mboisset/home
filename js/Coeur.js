titan = [
 {id:  0, x: 412, y: 404, lvl:3, top:[144], left:[144], right:[144]},  // top
 {id:  1, x: 828, y: 404, lvl:3, top:[144], left:[144], right:[144]},  
 {id:  2, x: 308, y: 556, lvl:3, top:[144], left:[144], right:[3]  },  
 {id:  3, x: 412, y: 556, lvl:3, top:[144], left:[2],   right:[4]  },  
 {id:  4, x: 516, y: 556, lvl:3, top:[144], left:[3],   right:[5]  }, 
 {id:  5, x: 620, y: 556, lvl:3, top:[144], left:[4],   right:[6]  },
 {id:  6, x: 724, y: 556, lvl:3, top:[144], left:[5],   right:[7]  },
 {id:  7, x: 828, y: 556, lvl:3, top:[144], left:[6],   right:[8]  },
 {id:  8, x: 932, y: 556, lvl:3, top:[144], left:[7],   right:[144]},
 {id:  9, x: 308, y: 708, lvl:3, top:[144], left:[144], right:[10] },
 {id: 10, x: 412, y: 708, lvl:3, top:[144], left:[9],   right:[11] },
 {id: 11, x: 516, y: 708, lvl:3, top:[144], left:[10],  right:[12] },
 {id: 12, x: 620, y: 708, lvl:3, top:[144], left:[11],  right:[13] }, 
 {id: 13, x: 724, y: 708, lvl:3, top:[144], left:[12],  right:[14] },
 {id: 14, x: 828, y: 708, lvl:3, top:[144], left:[13],  right:[15] },
 {id: 15, x: 932, y: 708, lvl:3, top:[144], left:[14],  right:[144]},
 {id: 16, x: 412, y: 860, lvl:3, top:[144], left:[144], right:[17] },  
 {id: 17, x: 516, y: 860, lvl:3, top:[144], left:[16],  right:[18] },
 {id: 18, x: 620, y: 860, lvl:3, top:[144], left:[17],  right:[19] },
 {id: 19, x: 724, y: 860, lvl:3, top:[144], left:[18],  right:[20] },
 {id: 20, x: 828, y: 860, lvl:3, top:[144], left:[19],  right:[144]},
 {id: 21, x: 516, y:1012, lvl:3, top:[144], left:[144], right:[22] },
 {id: 22, x: 620, y:1012, lvl:3, top:[144], left:[21],  right:[23] },
 {id: 23, x: 724, y:1012, lvl:3, top:[144], left:[22],  right:[144]},
 {id: 24, x: 620, y:1164, lvl:3, top:[144], left:[144], right:[144]},
 {id: 25, x: 204, y: 252, lvl:2, top:[144], left:[144], right:[26] }, // lvl2
 {id: 26, x: 308, y: 252, lvl:2, top:[144], left:[25],  right:[27] },
 {id: 27, x: 412, y: 252, lvl:2, top:[144], left:[26],  right:[144]},
 {id: 28, x: 828, y: 252, lvl:2, top:[144], left:[144], right:[29] }, 
 {id: 29, x: 932, y: 252, lvl:2, top:[144], left:[28],  right:[30] },
 {id: 30, x:1036, y: 252, lvl:2, top:[144], left:[29],  right:[144]},
 {id: 31, x: 204, y: 404, lvl:2, top:[144], left:[144], right:[32] },
 {id: 32, x: 308, y: 404, lvl:2, top:[144], left:[31],  right:[33] },
 {id: 33, x: 412, y: 404, lvl:2, top:[0],   left:[32],  right:[34] },
 {id: 34, x: 516, y: 404, lvl:2, top:[144], left:[33],  right:[35] },
 {id: 35, x: 620, y: 404, lvl:2, top:[144], left:[34],  right:[36] },
 {id: 36, x: 724, y: 404, lvl:2, top:[144], left:[35],  right:[37] },
 {id: 37, x: 828, y: 404, lvl:2, top:[1],   left:[36],  right:[38] },
 {id: 38, x: 932, y: 404, lvl:2, top:[144], left:[37],  right:[39] },
 {id: 39, x:1036, y: 404, lvl:2, top:[144], left:[38],  right:[144]},
 {id: 40, x: 204, y: 556, lvl:2, top:[144], left:[144], right:[41] },  
 {id: 41, x: 308, y: 556, lvl:2, top:[2],   left:[40],  right:[42] },
 {id: 42, x: 412, y: 556, lvl:2, top:[3],   left:[41],  right:[43] },
 {id: 43, x: 516, y: 556, lvl:2, top:[4],   left:[42],  right:[44] },
 {id: 44, x: 620, y: 556, lvl:2, top:[5],   left:[43],  right:[45] },
 {id: 45, x: 724, y: 556, lvl:2, top:[6],   left:[44],  right:[46] },
 {id: 46, x: 828, y: 556, lvl:2, top:[7],   left:[45],  right:[47] },
 {id: 47, x: 932, y: 556, lvl:2, top:[8],   left:[46],  right:[48] },
 {id: 48, x:1036, y: 556, lvl:2, top:[144], left:[47],  right:[144]},
 {id: 49, x: 308, y: 708, lvl:2, top:[9],   left:[144], right:[50] },
 {id: 50, x: 412, y: 708, lvl:2, top:[10],  left:[49],  right:[51] },
 {id: 51, x: 516, y: 708, lvl:2, top:[11],  left:[50],  right:[52] },
 {id: 52, x: 620, y: 708, lvl:2, top:[12],  left:[51],  right:[53] },
 {id: 53, x: 724, y: 708, lvl:2, top:[13],  left:[52],  right:[54] },
 {id: 54, x: 828, y: 708, lvl:2, top:[14],  left:[53],  right:[55] }, 
 {id: 55, x: 932, y: 708, lvl:2, top:[15],  left:[54],  right:[144]},
 {id: 56, x: 308, y: 860, lvl:2, top:[144], left:[144], right:[57] },
 {id: 57, x: 412, y: 860, lvl:2, top:[16],  left:[56],  right:[58] },
 {id: 58, x: 516, y: 860, lvl:2, top:[17],  left:[57],  right:[59] },
 {id: 59, x: 620, y: 860, lvl:2, top:[18],  left:[58],  right:[60] },
 {id: 60, x: 724, y: 860, lvl:2, top:[19],  left:[59],  right:[61] },
 {id: 61, x: 828, y: 860, lvl:2, top:[20],  left:[60],  right:[62] },
 {id: 62, x: 932, y: 860, lvl:2, top:[144], left:[61],  right:[144]},
 {id: 63, x: 412, y:1012, lvl:2, top:[144], left:[144], right:[64] },
 {id: 64, x: 516, y:1012, lvl:2, top:[21],  left:[63],  right:[65] },
 {id: 65, x: 620, y:1012, lvl:2, top:[22],  left:[64],  right:[66] },
 {id: 66, x: 724, y:1012, lvl:2, top:[23],  left:[65],  right:[67] },
 {id: 67, x: 828, y:1012, lvl:2, top:[144], left:[66],  right:[144]},
 {id: 68, x: 516, y:1164, lvl:2, top:[144], left:[144], right:[69] },
 {id: 69, x: 620, y:1164, lvl:2, top:[24],  left:[68],  right:[70] },
 {id: 70, x: 724, y:1164, lvl:2, top:[144], left:[69],  right:[144]},
 {id: 71, x: 620, y:1316, lvl:2, top:[144], left:[144], right:[144]},
 {id: 72, x: 204, y: 100, lvl:1, top:[144], left:[144], right:[73] }, // lvl3
 {id: 73, x: 308, y: 100, lvl:1, top:[144], left:[72],  right:[74] },
 {id: 74, x: 412, y: 100, lvl:1, top:[144], left:[73],  right:[144]},
 {id: 75, x: 828, y: 100, lvl:1, top:[144], left:[144], right:[76] },
 {id: 76, x: 932, y: 100, lvl:1, top:[144], left:[75],  right:[77] },
 {id: 77, x:1036, y: 100, lvl:1, top:[144], left:[76],  right:[144]},
 {id: 78, x: 100, y: 252, lvl:1, top:[144], left:[144], right:[79] },
 {id: 79, x: 204, y: 252, lvl:1, top:[25],  left:[78],  right:[80] },
 {id: 80, x: 308, y: 252, lvl:1, top:[26],  left:[79],  right:[81] },
 {id: 81, x: 412, y: 252, lvl:1, top:[27],  left:[80],  right:[82] }, 
 {id: 82, x: 516, y: 252, lvl:1, top:[144], left:[81],  right:[83] }, 
 {id: 83, x: 724, y: 252, lvl:1, top:[144], left:[82],  right:[84] },
 {id: 84, x: 828, y: 252, lvl:1, top:[28],  left:[83],  right:[85] },
 {id: 85, x: 932, y: 252, lvl:1, top:[29],  left:[84],  right:[86] },
 {id: 86, x:1036, y: 252, lvl:1, top:[30],  left:[85],  right:[87] },
 {id: 87, x:1140, y: 252, lvl:1, top:[144], left:[86],  right:[144]},
 {id: 88, x: 100, y: 404, lvl:1, top:[144], left:[144], right:[89] },
 {id: 89, x: 204, y: 404, lvl:1, top:[31],  left:[88],  right:[90] },
 {id: 90, x: 308, y: 404, lvl:1, top:[32],  left:[89],  right:[91] },
 {id: 91, x: 412, y: 404, lvl:1, top:[33],  left:[90],  right:[92] },
 {id: 92, x: 516, y: 404, lvl:1, top:[34],  left:[91],  right:[93] },
 {id: 93, x: 620, y: 404, lvl:1, top:[35],  left:[92],  right:[94] },
 {id: 94, x: 724, y: 404, lvl:1, top:[36],  left:[93],  right:[95] }, 
 {id: 95, x: 828, y: 404, lvl:1, top:[37],  left:[94],  right:[96] },
 {id: 96, x: 932, y: 404, lvl:1, top:[38],  left:[95],  right:[97] },
 {id: 97, x:1036, y: 404, lvl:1, top:[39],  left:[96],  right:[98] },
 {id: 98, x:1140, y: 404, lvl:1, top:[144], left:[97],  right:[144]},
 {id: 99, x: 100, y: 556, lvl:1, top:[144], left:[144], right:[100]},
 {id:100, x: 204, y: 556, lvl:1, top:[40],  left:[99],  right:[101]},
 {id:101, x: 308, y: 556, lvl:1, top:[41],  left:[100], right:[102]},
 {id:102, x: 412, y: 556, lvl:1, top:[42],  left:[101], right:[103]},
 {id:103, x: 516, y: 556, lvl:1, top:[43],  left:[102], right:[104]},
 {id:104, x: 620, y: 556, lvl:1, top:[44],  left:[103], right:[105]},
 {id:105, x: 724, y: 556, lvl:1, top:[45],  left:[104], right:[106]},
 {id:106, x: 828, y: 556, lvl:1, top:[46],  left:[105], right:[107]},
 {id:107, x: 932, y: 556, lvl:1, top:[47],  left:[106], right:[108]},
 {id:108, x:1036, y: 556, lvl:1, top:[48],  left:[107], right:[109]},
 {id:109, x:1140, y: 556, lvl:1, top:[144], left:[108], right:[144]},
 {id:110, x: 204, y: 708, lvl:1, top:[144], left:[144], right:[111]},
 {id:111, x: 308, y: 708, lvl:1, top:[49],  left:[110], right:[112]},
 {id:112, x: 412, y: 708, lvl:1, top:[50],  left:[111], right:[113]},
 {id:113, x: 516, y: 708, lvl:1, top:[51],  left:[112], right:[114]},
 {id:114, x: 620, y: 708, lvl:1, top:[52],  left:[113], right:[115]},
 {id:115, x: 724, y: 708, lvl:1, top:[53],  left:[114], right:[116]},
 {id:116, x: 828, y: 708, lvl:1, top:[54],  left:[115], right:[117]},
 {id:117, x: 932, y: 708, lvl:1, top:[55],  left:[116], right:[118]},
 {id:118, x:1036, y: 708, lvl:1, top:[144], left:[117], right:[144]},
 {id:119, x: 204, y: 860, lvl:1, top:[144], left:[144], right:[120]},
 {id:120, x: 308, y: 860, lvl:1, top:[56],  left:[119], right:[121]},
 {id:121, x: 412, y: 860, lvl:1, top:[57],  left:[120], right:[122]},
 {id:122, x: 516, y: 860, lvl:1, top:[58],  left:[121], right:[123]},
 {id:123, x: 620, y: 860, lvl:1, top:[59],  left:[122], right:[124]},
 {id:124, x: 724, y: 860, lvl:1, top:[60],  left:[123], right:[125]},
 {id:125, x: 828, y: 860, lvl:1, top:[61],  left:[124], right:[126]},
 {id:126, x: 932, y: 860, lvl:1, top:[62],  left:[125], right:[127]},
 {id:127, x:1036, y: 860, lvl:1, top:[144], left:[126], right:[144]},
 {id:128, x: 308, y:1012, lvl:1, top:[144], left:[144], right:[129]},
 {id:129, x: 412, y:1012, lvl:1, top:[63],  left:[128], right:[130]},
 {id:130, x: 516, y:1012, lvl:1, top:[64],  left:[129], right:[131]},
 {id:131, x: 620, y:1012, lvl:1, top:[65],  left:[130], right:[132]},
 {id:132, x: 724, y:1012, lvl:1, top:[66],  left:[131], right:[133]},
 {id:133, x: 828, y:1012, lvl:1, top:[67],  left:[132], right:[134]},
 {id:134, x: 932, y:1012, lvl:1, top:[144], left:[133], right:[144]},
 {id:135, x: 412, y:1164, lvl:1, top:[144], left:[144], right:[136]},
 {id:136, x: 516, y:1164, lvl:1, top:[68],  left:[135], right:[137]},
 {id:137, x: 620, y:1164, lvl:1, top:[69],  left:[136], right:[138]},
 {id:138, x: 724, y:1164, lvl:1, top:[70],  left:[137], right:[139]},
 {id:139, x: 828, y:1164, lvl:1, top:[144], left:[138], right:[144]},
 {id:140, x: 516, y:1316, lvl:1, top:[144], left:[144], right:[141]},
 {id:141, x: 620, y:1316, lvl:1, top:[144], left:[140], right:[142]},
 {id:142, x: 724, y:1316, lvl:1, top:[71],  left:[141], right:[144]},
 {id:143, x: 620, y:1488, lvl:1, top:[144], left:[144], right:[144]},
 {id:144, x:   0, y:   0, lvl:1, top:[144], left:[144], right:[144]}
];
tileFrom = tileTo = '';

function start() {
  if (titan[0].x == 412) for (i = 0; i < titan.length; i++) { titan[i].x += 200; titan[i].y += 100;  }
  shuffle();
  document.getElementById('tiles_set').play(); 
  for (i = 0; i < 144; i++) {
    tiles[i].onmouseover = function(event) { help(this.id); event.stopPropagation(); };
    tiles[i].onmouseout  = function(event) { unhelp(this.id); event.stopPropagation(); };
    titan[i].tile = tiles[shuffled[i]];
    tiles[shuffled[i]].titan = titan[i].id;
    tiles[shuffled[i]].faceUp();
    tiles[shuffled[i]].moveTo(titan[i].x - titan[i].lvl * 14, (titan[i].y - titan[i].lvl * 14) - 130, titan[i].x*50 + titan[i].lvl * 5000 + titan[i].id);
  }
  titan[144].top = titan[144].left = titan[144].right = titan[144].tile = '';
  cnt = 0;
  strt = new Date().getTime();
  timer =  setInterval(tmr, 1000);
  countMvt(0);
}

function declick() {
  console.log('declick');
  if (tileFrom != '') tiles[tileFrom].unselect();
  if (tileTo != '') tiles[tileTo].unselect();
  tileFrom = tileTo = '';
}

function tileAction(tile) {
  if (tileFrom == '') {
    tileFrom = tile;
    tileTo = '';
    tf = titan[tiles[tileFrom].titan];
    if (tiles[tileFrom].titan == 0 || titan[tf.top[0]].tile == '' && (titan[tf.left[0]].tile == '' || titan[tf.right[0]].tile == '')) {
      tiles[tileFrom].select();
      document.getElementById('tile_click').play();
    }  
    else {
      declick();
      document.getElementById('tile_locked').play();
    }
  }
  else {
    tileTo = tile;
    tt = titan[tiles[tileTo].titan];
    if (tileFrom != tileTo && tiles[tileFrom].titan == 0 || tileFrom != tileTo && titan[tt.top[0]].tile == '' && (titan[tt.left[0]].tile == '' || titan[tt.right[0]].tile == '')) {
      tiles[tileTo].select();
      if (tiles[tileTo].col == tiles[tileFrom].col && tiles[tileTo].val == tiles[tileFrom].val) {
        tiles[tileTo].moveTo(-2000, -200, 100000);
        tiles[tileFrom].moveTo(-2000, -200, 100000);
        tf.tile = tt.tile = '';
        document.getElementById('tiles_gone').play();
      }
    }
    else document.getElementById('tile_drop').play();
    countMvt(1);
    declick();
  }
}

var tl = [], pairs = [];
function countMvt(n) {
  cnt += n;
  tr = 0;
  for (i = 0; i < 144; i++) if (titan[i].tile != '') tr++;
  ret = 0;
  tl = tl.splice(0,0);
  pairs = pairs.splice(0,0);
  for (i = 0; i < 144; i++) {
    if (titan[titan[i].top[0]].tile == "" && (titan[titan[i].left[0]].tile == "" || titan[titan[i].right[0]].tile == "") && titan[i].tile != '') tl.push(titan[i].tile);
  }
  p = 0;
  for (i=0; i < tl.length; i++) for(j = i+1; j < tl.length; j++)
    if (tl[i].col == tl[j].col && tl[i].val == tl[j].val) {
      p++;
      pairs.push(tl[i]);
      pairs.push(tl[j]);
    }
  document.getElementById('count').innerHTML = 
      '<h1>Temps :         </h1><div id="timer">' + timerTxt + '</div>'+
      '<h1>Mouvt :         </h1><div>' + cnt       + '</div>'+
      '<h1>Tuiles en jeu : </h1><div>' + tr        + '</div>'+
      '<h1>Tuiles libres : </h1><div>' + tl.length + '</div>'+
      '<h1>Paires dispo. : </h1><div>' + p         + '</div>';
  if (tr == 0) tadaa('Mahjong');
  else if (p == 0) boooh('Mahjong');
}

function show_pairs() {
  for (i = 0; i < pairs.length; i++) pairs[i].classList.add('tile_lvl3');
}

function hide_pairs() {
  for (i = 0; i < pairs.length; i++)  pairs[i].classList.remove('tile_lvl3');
}

function help(id) {
  if (document.getElementById('hlp').checked) {
    t = document.getElementById(id);
    for (i = 0; i < pairs.length; i++) {
      if (pairs[i].id != id && pairs[i].col == t.col && pairs[i].val == t.val) pairs[i].classList.add('tile_lvl3');
    }
  }
}

function unhelp() {
  while (document.getElementsByClassName('tile_lvl3').length > 0) document.getElementsByClassName('tile_lvl3')[0].classList.remove('tile_lvl3');
}