titan = [
 {id:  0, x: 100, y: 100, lvl:5, top:[144],left:[144], right:[144]},  // top
 {id:  1, x:1452, y: 100, lvl:5, top:[144],left:[144], right:[144]},  
 {id:  2, x: 100, y:1012, lvl:5, top:[144],left:[144], right:[144]},  
 {id:  3, x:1452, y:1012, lvl:5, top:[144],left:[144], right:[144]},  
 {id:  4, x: 100, y: 100, lvl:4, top:[0],  left:[144], right:[5]  }, // lvl2
 {id:  5, x: 204, y: 100, lvl:4, top:[144],left:[4],   right:[144]},
 {id:  6, x:1348, y: 100, lvl:4, top:[0],  left:[144], right:[7]  },
 {id:  7, x:1452, y: 100, lvl:4, top:[1],  left:[6],   right:[144]},
 {id:  8, x: 100, y: 252, lvl:4, top:[144],left:[144], right:[144]},
 {id:  9, x:1452, y: 252, lvl:4, top:[144],left:[144], right:[144]},
 {id: 10, x: 100, y: 860, lvl:4, top:[144],left:[144], right:[144]},
 {id: 11, x:1452, y: 860, lvl:4, top:[144],left:[144], right:[144]},
 {id: 12, x: 100, y:1012, lvl:4, top:[2],  left:[144], right:[13] },
 {id: 13, x: 204, y:1012, lvl:4, top:[144],left:[12],  right:[144]},
 {id: 14, x:1348, y:1012, lvl:4, top:[144],left:[144], right:[15] },
 {id: 15, x:1452, y:1012, lvl:4, top:[3],  left:[14],  right:[144]},
 {id: 16, x: 100, y: 100, lvl:3, top:[4],  left:[144], right:[17] },  // lvl3
 {id: 17, x: 204, y: 100, lvl:3, top:[5],  left:[16],  right:[18] },
 {id: 18, x: 308, y: 100, lvl:3, top:[144],left:[17],  right:[144]},
 {id: 19, x:1244, y: 100, lvl:3, top:[144],left:[144], right:[20] },
 {id: 20, x:1348, y: 100, lvl:3, top:[6],  left:[19],  right:[21] },
 {id: 21, x:1452, y: 100, lvl:3, top:[7],  left:[20],  right:[144]},
 {id: 22, x: 100, y: 252, lvl:3, top:[8],  left:[144], right:[23] },
 {id: 23, x: 204, y: 252, lvl:3, top:[144],left:[22],  right:[144]},
 {id: 24, x:1348, y: 252, lvl:3, top:[144],left:[144], right:[25] },
 {id: 25, x:1452, y: 252, lvl:3, top:[9],  left:[24],  right:[144]},
 {id: 26, x: 100, y: 404, lvl:3, top:[144],left:[144], right:[144]},
 {id: 27, x:1452, y: 404, lvl:3, top:[144],left:[144], right:[144]},
 {id: 28, x: 100, y: 708, lvl:3, top:[144],left:[144], right:[144]},
 {id: 29, x:1452, y: 708, lvl:3, top:[144],left:[144], right:[144]},
 {id: 30, x: 100, y: 860, lvl:3, top:[10], left:[144], right:[31] },
 {id: 31, x: 204, y: 860, lvl:3, top:[144],left:[30],  right:[144]},
 {id: 32, x:1348, y: 860, lvl:3, top:[144],left:[144], right:[33] },
 {id: 33, x:1452, y: 860, lvl:3, top:[11], left:[32],  right:[144]},
 {id: 34, x: 100, y:1012, lvl:3, top:[12], left:[144], right:[35] },
 {id: 35, x: 204, y:1012, lvl:3, top:[13], left:[34],  right:[36] },
 {id: 36, x: 308, y:1012, lvl:3, top:[144],left:[35],  right:[144]},
 {id: 37, x:1244, y:1012, lvl:3, top:[144],left:[144], right:[38] },
 {id: 38, x:1348, y:1012, lvl:3, top:[14], left:[37],  right:[39] },
 {id: 39, x:1452, y:1012, lvl:3, top:[15], left:[38],  right:[144]},
 {id: 40, x: 100, y: 100, lvl:2, top:[16], left:[144], right:[41] },  // lvl4
 {id: 41, x: 204, y: 100, lvl:2, top:[17], left:[40],  right:[42] },
 {id: 42, x: 308, y: 100, lvl:2, top:[18], left:[41],  right:[43] },
 {id: 43, x: 412, y: 100, lvl:2, top:[144],left:[42],  right:[144]},
 {id: 44, x:1140, y: 100, lvl:2, top:[144],left:[144], right:[45] },
 {id: 45, x:1244, y: 100, lvl:2, top:[19], left:[44],  right:[46] },
 {id: 46, x:1348, y: 100, lvl:2, top:[20], left:[45],  right:[47] },
 {id: 47, x:1452, y: 100, lvl:2, top:[21], left:[46],  right:[144]},
 {id: 48, x: 100, y: 252, lvl:2, top:[22], left:[144], right:[49] },
 {id: 49, x: 204, y: 252, lvl:2, top:[23], left:[48],  right:[50] },
 {id: 50, x: 308, y: 252, lvl:2, top:[144],left:[49],  right:[144]},
 {id: 51, x: 776, y: 252, lvl:2, top:[144],left:[144], right:[144]},
 {id: 52, x:1244, y: 252, lvl:2, top:[144],left:[144], right:[53] },
 {id: 53, x:1348, y: 252, lvl:2, top:[24], left:[52],  right:[54] },
 {id: 54, x:1452, y: 252, lvl:2, top:[25], left:[53],  right:[144]},
 {id: 55, x: 100, y: 404, lvl:2, top:[26], left:[144], right:[56] },
 {id: 56, x: 204, y: 404, lvl:2, top:[144],left:[55],  right:[144]},
 {id: 57, x:1348, y: 404, lvl:2, top:[144],left:[144], right:[58] },
 {id: 58, x:1452, y: 404, lvl:2, top:[27], left:[57],  right:[144]},
 {id: 59, x: 100, y: 556, lvl:2, top:[144],left:[144], right:[144]},
 {id: 60, x: 776, y: 556, lvl:2, top:[144],left:[144], right:[144]},
 {id: 61, x:1452, y: 556, lvl:2, top:[144],left:[144], right:[144]},
 {id: 62, x: 100, y: 708, lvl:2, top:[28], left:[144], right:[62] },
 {id: 63, x: 204, y: 708, lvl:2, top:[144],left:[62],  right:[144]},
 {id: 64, x:1348, y: 708, lvl:2, top:[144],left:[144], right:[65] },
 {id: 65, x:1452, y: 708, lvl:2, top:[29], left:[64],  right:[144]},
 {id: 66, x: 100, y: 860, lvl:2, top:[30], left:[144], right:[67] },
 {id: 67, x: 204, y: 860, lvl:2, top:[31], left:[66],  right:[68] },
 {id: 68, x: 308, y: 860, lvl:2, top:[144],left:[67],  right:[144]},
 {id: 69, x: 776, y: 860, lvl:2, top:[144],left:[144], right:[144]},
 {id: 70, x:1244, y: 860, lvl:2, top:[144],left:[144], right:[71] },
 {id: 71, x:1348, y: 860, lvl:2, top:[32], left:[70],  right:[72] },
 {id: 72, x:1452, y: 860, lvl:2, top:[33], left:[71],  right:[144]},
 {id: 73, x: 100, y:1012, lvl:2, top:[34], left:[144], right:[74] },
 {id: 74, x: 204, y:1012, lvl:2, top:[35], left:[73],  right:[75] },
 {id: 75, x: 308, y:1012, lvl:2, top:[36], left:[74],  right:[76] },
 {id: 76, x: 412, y:1012, lvl:2, top:[144],left:[75],  right:[144]},
 {id: 77, x:1140, y:1012, lvl:2, top:[144],left:[144], right:[78] },
 {id: 78, x:1244, y:1012, lvl:2, top:[37], left:[77],  right:[79] },
 {id: 79, x:1348, y:1012, lvl:2, top:[38], left:[78],  right:[80] },
 {id: 80, x:1452, y:1012, lvl:2, top:[39], left:[79],  right:[144]},
 {id: 81, x: 100, y: 100, lvl:1, top:[40], left:[144], right:[82] },  // lvl5
 {id: 82, x: 204, y: 100, lvl:1, top:[41], left:[81],  right:[83] },
 {id: 83, x: 308, y: 100, lvl:1, top:[42], left:[82],  right:[84] },
 {id: 84, x: 412, y: 100, lvl:1, top:[43], left:[83],  right:[85] },
 {id: 85, x: 516, y: 100, lvl:1, top:[144],left:[84],  right:[144]},
 {id: 86, x:1036, y: 100, lvl:1, top:[144],left:[144], right:[87] },
 {id: 87, x:1140, y: 100, lvl:1, top:[44], left:[86],  right:[88] },
 {id: 88, x:1244, y: 100, lvl:1, top:[45], left:[87],  right:[89] },
 {id: 89, x:1348, y: 100, lvl:1, top:[46], left:[88],  right:[90] },
 {id: 90, x:1452, y: 100, lvl:1, top:[47], left:[89],  right:[144]},
 {id: 91, x: 100, y: 252, lvl:1, top:[48], left:[144], right:[92] },
 {id: 92, x: 204, y: 252, lvl:1, top:[49], left:[91],  right:[93] },
 {id: 93, x: 308, y: 252, lvl:1, top:[50], left:[92],  right:[94] },
 {id: 94, x: 412, y: 252, lvl:1, top:[144],left:[93],  right:[144]},
 {id: 95, x: 672, y: 252, lvl:1, top:[144],left:[144], right:[96] },
 {id: 96, x: 776, y: 252, lvl:1, top:[51], left:[95],  right:[97] },
 {id: 97, x: 880, y: 252, lvl:1, top:[144],left:[96],  right:[144]},
 {id: 98, x:1140, y: 252, lvl:1, top:[144],left:[144], right:[99] },
 {id: 99, x:1244, y: 252, lvl:1, top:[52], left:[98],  right:[100]},
 {id:100, x:1348, y: 252, lvl:1, top:[53], left:[99],  right:[101]},
 {id:101, x:1452, y: 252, lvl:1, top:[54], left:[100], right:[144]},
 {id:102, x: 100, y: 404, lvl:1, top:[55], left:[144], right:[103]},
 {id:103, x: 204, y: 404, lvl:1, top:[56], left:[102], right:[104]},
 {id:104, x: 308, y: 404, lvl:1, top:[144],left:[103], right:[144]},
 {id:105, x: 776, y: 404, lvl:1, top:[144],left:[144], right:[144]},
 {id:106, x:1244, y: 404, lvl:1, top:[144],left:[144], right:[107]},
 {id:107, x:1348, y: 404, lvl:1, top:[57], left:[106], right:[108]},
 {id:108, x:1452, y: 404, lvl:1, top:[58], left:[107], right:[144]},
 {id:109, x: 100, y: 556, lvl:1, top:[59], left:[144], right:[110]},
 {id:110, x: 204, y: 556, lvl:1, top:[144],left:[109], right:[144]},
 {id:111, x: 672, y: 556, lvl:1, top:[144],left:[144], right:[112]},
 {id:112, x: 776, y: 556, lvl:1, top:[60], left:[111], right:[113]},
 {id:113, x: 880, y: 556, lvl:1, top:[144],left:[112], right:[144]},
 {id:114, x:1348, y: 556, lvl:1, top:[144],left:[144], right:[115]},
 {id:115, x:1452, y: 556, lvl:1, top:[61], left:[114], right:[144]},
 {id:116, x: 100, y: 708, lvl:1, top:[62], left:[144], right:[117]},
 {id:117, x: 204, y: 708, lvl:1, top:[63], left:[116], right:[118]},
 {id:118, x: 308, y: 708, lvl:1, top:[144],left:[117], right:[144]},
 {id:119, x: 776, y: 708, lvl:1, top:[144],left:[144], right:[144]},
 {id:120, x:1244, y: 708, lvl:1, top:[144],left:[144], right:[121]},
 {id:121, x:1348, y: 708, lvl:1, top:[64], left:[120], right:[122]},
 {id:122, x:1452, y: 708, lvl:1, top:[65], left:[121], right:[144]},
 {id:123, x: 100, y: 860, lvl:1, top:[66], left:[144], right:[124]},
 {id:124, x: 204, y: 860, lvl:1, top:[67], left:[123], right:[125]},
 {id:125, x: 308, y: 860, lvl:1, top:[68], left:[124], right:[126]},
 {id:126, x: 412, y: 860, lvl:1, top:[144],left:[125], right:[144]},
 {id:127, x: 672, y: 860, lvl:1, top:[144],left:[144], right:[128]},
 {id:128, x: 776, y: 860, lvl:1, top:[69], left:[127], right:[129]},
 {id:129, x: 880, y: 860, lvl:1, top:[144],left:[128], right:[144]},
 {id:130, x:1140, y: 860, lvl:1, top:[144],left:[144], right:[131]},
 {id:131, x:1244, y: 860, lvl:1, top:[70], left:[130], right:[132]},
 {id:132, x:1348, y: 860, lvl:1, top:[71], left:[131], right:[133]},
 {id:133, x:1452, y: 860, lvl:1, top:[72], left:[132], right:[144]},
 {id:134, x: 100, y:1012, lvl:1, top:[73], left:[144], right:[135]},
 {id:135, x: 204, y:1012, lvl:1, top:[74], left:[134], right:[136]},
 {id:136, x: 308, y:1012, lvl:1, top:[75], left:[135], right:[137]},
 {id:137, x: 412, y:1012, lvl:1, top:[76], left:[136], right:[138]},
 {id:138, x: 516, y:1012, lvl:1, top:[144],left:[137], right:[144]},
 {id:139, x:1036, y:1012, lvl:1, top:[144],left:[144], right:[140]},
 {id:140, x:1140, y:1012, lvl:1, top:[77], left:[139], right:[141]},
 {id:141, x:1244, y:1012, lvl:1, top:[78], left:[140], right:[142]},
 {id:142, x:1348, y:1012, lvl:1, top:[79], left:[141], right:[143]},
 {id:143, x:1452, y:1012, lvl:1, top:[80], left:[142], right:[144]},
 {id:144, x:   0, y:   0, lvl:1, top:[144],left:[144], right:[144]}
];
tileFrom = tileTo = '';

function start() {
  if (titan[0].x == 100) for (i = 0; i < titan.length; i++) { titan[i].x += 200; titan[i].y += 150;  }
  shuffle();
  document.getElementById('tiles_set').play(); 
  for (i = 0; i < 144; i++) {
    tiles[i].onmouseover = function(event) { help(this.id); event.stopPropagation(); };
    tiles[i].onmouseout  = function(event) { unhelp(this.id); event.stopPropagation(); };
    titan[i].tile = tiles[shuffled[i]];
    tiles[shuffled[i]].titan = titan[i].id;
    tiles[shuffled[i]].faceUp();
    tiles[shuffled[i]].moveTo(titan[i].x - titan[i].lvl * 14, (titan[i].y - titan[i].lvl * 14) - 130, titan[i].x*50 + titan[i].lvl * 5000 + titan[i].id);
  }
  titan[144].top = titan[144].left = titan[144].right = titan[144].tile = '';
  cnt = 0;
  strt = new Date().getTime();
  timer =  setInterval(tmr, 1000);
  countMvt(0);
}

function declick() {
  console.log('declick');
  if (tileFrom != '') tiles[tileFrom].unselect();
  if (tileTo != '') tiles[tileTo].unselect();
  tileFrom = tileTo = '';
}

function tileAction(tile) {
  if (tileFrom == '') {
    tileFrom = tile;
    tileTo = '';
    tf = titan[tiles[tileFrom].titan];
    if (tiles[tileFrom].titan == 0 || titan[tf.top].tile == '' && (titan[tf.left[0]].tile == '' || titan[tf.right[0]].tile == '')) {
      tiles[tileFrom].select();
      document.getElementById('tile_click').play();
    }  
    else {
      declick();
      document.getElementById('tile_locked').play();
    }
  }
  else {
    tileTo = tile;
    tt = titan[tiles[tileTo].titan];
    if (tileFrom != tileTo && tiles[tileFrom].titan == 0 || tileFrom != tileTo && titan[tt.top].tile == '' && (titan[tt.left[0]].tile == '' || titan[tt.right[0]].tile == '')) {
      tiles[tileTo].select();
      if (tiles[tileTo].col == tiles[tileFrom].col && tiles[tileTo].val == tiles[tileFrom].val) {
        tiles[tileTo].moveTo(-2000, -200, 100000);
        tiles[tileFrom].moveTo(-2000, -200, 100000);
        tf.tile = tt.tile = '';
        document.getElementById('tiles_gone').play();
      }
    }
    else document.getElementById('tile_drop').play();
    countMvt(1);
    declick();
  }
}

var tl = [], pairs = [];
function countMvt(n) {
  cnt += n;
  tr = 0;
  for (i = 0; i < 144; i++) if (titan[i].tile != '') tr++;
  ret = 0;
  tl = tl.splice(0,0);
  pairs = pairs.splice(0,0);
  for (i = 0; i < 144; i++) {
    if (titan[titan[i].top[0]].tile == "" && (titan[titan[i].left[0]].tile == "" || titan[titan[i].right[0]].tile == "") && titan[i].tile != '') tl.push(titan[i].tile);
  }
  p = 0;
  for (i=0; i < tl.length; i++) for(j = i+1; j < tl.length; j++)
    if (tl[i].col == tl[j].col && tl[i].val == tl[j].val) {
      p++;
      pairs.push(tl[i]);
      pairs.push(tl[j]);
    }
  document.getElementById('count').innerHTML = 
      '<h1>Temps :         </h1><div id="timer">' + timerTxt + '</div>'+
      '<h1>Mouvt :         </h1><div>' + cnt       + '</div>'+
      '<h1>Tuiles en jeu : </h1><div>' + tr        + '</div>'+
      '<h1>Tuiles libres : </h1><div>' + tl.length + '</div>'+
      '<h1>Paires dispo. : </h1><div>' + p         + '</div>';
  if (tr == 0) tadaa('Mahjong');
  else if (p == 0) boooh('Mahjong');
}

function show_pairs() {
  for (i = 0; i < pairs.length; i++) pairs[i].classList.add('tile_lvl3');
}

function hide_pairs() {
  for (i = 0; i < pairs.length; i++)  pairs[i].classList.remove('tile_lvl3');
}

function help(id) {
  if (document.getElementById('hlp').checked) {
    t = document.getElementById(id);
    for (i = 0; i < pairs.length; i++) {
      if (pairs[i].id != id && pairs[i].col == t.col && pairs[i].val == t.val) pairs[i].classList.add('tile_lvl3');
    }
  }
}

function unhelp() {
  while (document.getElementsByClassName('tile_lvl3').length > 0) document.getElementsByClassName('tile_lvl3')[0].classList.remove('tile_lvl3');
}